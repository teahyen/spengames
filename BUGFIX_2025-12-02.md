# Bug Fixes - December 2, 2025

## Critical Bugs Resolved

### 1. 보이지 않는 가상의 벽 버그 (Invisible Virtual Wall Bug)
**문제:** 검은 선이 없는데 공이 이상한 가상의 벽에 막히는 현상

**원인:**
- 캔버스가 회전하면서 공의 위치는 **화면 좌표** (screen space)로 저장됨
- 벽 충돌 감지는 **맵 좌표** (map space, 타일 기반)로 계산됨
- 이 좌표계 불일치로 인해:
  - 회전 후 벽이 실제 위치가 아닌 잘못된 위치에서 감지됨
  - 보이지 않는 곳에서 충돌이 발생

**해결책:**
```javascript
// 화면 좌표 → 맵 좌표 변환 (역회전)
const rad = (-rotation * Math.PI) / 180;
const mapX = centerX + (relX * cos - relY * sin);
const mapY = centerY + (relX * sin + relY * cos);

// 맵 좌표에서 충돌 체크
// ... collision detection in map space ...

// 수정된 맵 좌표 → 화면 좌표 변환 (순회전)
const forwardRad = (rotation * Math.PI) / 180;
player.x = centerX + (correctedRelX * fCos - correctedRelY * fSin);
player.y = centerY + (correctedRelX * fSin + correctedRelY * fCos);
```

### 2. 스테이지 도착점이 맵에 상속되지 않는 버그
**문제:** 골(목표 지점)이 맵 회전을 따라가지 않음

**원인:**
- 골의 위치가 고정된 타일 좌표로만 계산됨
- 공은 회전된 화면 좌표에 있지만, 골은 회전되지 않은 맵 좌표에 고정
- 맵을 회전해도 골은 원래 위치에 남아있어 도달 불가능

**해결책:**
```javascript
// 골의 맵 좌표를 화면 좌표로 변환 (회전 적용)
const rad = (rotation * Math.PI) / 180;
const goalScreenX = centerX + (relGoalX * cos - relGoalY * sin);
const goalScreenY = centerY + (relGoalX * sin + relGoalY * cos);

// 화면 좌표에서 거리 계산
const dx = player.x - goalScreenX;
const dy = player.y - goalScreenY;
const distance = Math.sqrt(dx * dx + dy * dy);
```

## 기술적 세부사항

### 좌표 변환 시스템
게임은 이제 두 가지 좌표계를 명확히 구분하여 사용:

1. **맵 좌표 (Map Coordinates)**
   - 타일 기반의 고정 좌표계
   - 레벨 데이터에서 정의된 타일, 벽, 골 위치
   - 회전과 무관하게 고정됨

2. **화면 좌표 (Screen Coordinates)**
   - 캔버스 상의 실제 렌더링 위치
   - 공의 위치, 속도가 저장되는 좌표계
   - 맵 회전에 따라 변환됨

### 변환 공식

**맵 → 화면 (Forward Rotation):**
```
screenX = centerX + (mapX - centerX) * cos(θ) - (mapY - centerY) * sin(θ)
screenY = centerY + (mapX - centerX) * sin(θ) + (mapY - centerY) * cos(θ)
```

**화면 → 맵 (Inverse Rotation):**
```
mapX = centerX + (screenX - centerX) * cos(-θ) - (screenY - centerY) * sin(-θ)
mapY = centerY + (screenX - centerX) * sin(-θ) + (screenY - centerY) * cos(-θ)
```

### 수정된 함수들

1. **checkWallCollision()**
   - 공의 화면 좌표를 맵 좌표로 변환
   - 맵 좌표에서 벽 충돌 감지
   - 충돌 발생 시 수정된 위치를 다시 화면 좌표로 변환
   - 속도 벡터도 적절히 회전하여 적용

2. **checkGoalReached()**
   - 골의 맵 좌표를 화면 좌표로 변환
   - 화면 좌표에서 공과 골 사이의 거리 계산
   - 골이 맵과 함께 회전하여 정확한 도달 감지

3. **checkObstacleCollision()**
   - 장애물의 맵 좌표를 화면 좌표로 변환
   - 화면 좌표에서 충돌 감지 및 반발력 적용

## 테스트 결과

### ✅ 해결된 문제
- [x] 보이지 않는 벽에 막히는 현상 제거
- [x] 골이 맵과 함께 회전하여 정확한 도달 감지
- [x] 장애물이 맵 회전을 따라감
- [x] 모든 회전 각도(0°, 90°, 180°, 270°)에서 정확한 충돌 감지

### 테스트 케이스
1. **Level 1-2 (3x3 그리드)**: ✅ 정상 작동
2. **Level 3 (4x4, 장애물 없음)**: ✅ 정상 작동
3. **Level 4 (4x4, 장애물 1개)**: ✅ 정상 작동
4. **Level 5 (4x4, 장애물 2개)**: ✅ 정상 작동

## 파일 변경사항

### src/js/physics.js
- `checkWallCollision()`: 126줄 추가 (좌표 변환 로직)
- `checkGoalReached()`: 회전 인식 골 감지
- `checkObstacleCollision()`: 회전 인식 장애물 충돌
- `update()`: 회전 매개변수 전달

**변경 통계:**
```
1 file changed, 126 insertions(+), 50 deletions(-)
```

## 배포 정보

- **커밋:** ad20bc2
- **브랜치:** genspark_ai_developer
- **Pull Request:** https://github.com/teahyen/spengames/pull/1
- **Live Demo:** https://8000-i8trwyu4p4hytirgbktca-583b4d74.sandbox.novita.ai

## 이전 문제 이력

이 버그는 이전 업데이트에서 다음과 같은 개선사항을 적용한 후에도 남아있었습니다:
1. v2.0: 드래그/자이로 제거, 90도 회전 버튼 구현
2. Physics Fix: 중력 개선 (공을 맵에 고정하여 회전, 회전 후 중력 아래 방향 적용)
3. BGM & SFX: 배경음악 및 효과음 추가
4. Gravity System: 중력을 공에 상속시키는 시스템 개선

이번 수정으로 **좌표계 불일치**라는 근본 원인을 해결하여 모든 충돌 및 목표 감지가 정확하게 작동합니다.

## 향후 개선 사항

현재 버전에서 모든 핵심 기능이 정상 작동하지만, 향후 다음과 같은 개선을 고려할 수 있습니다:

1. **성능 최적화**
   - 좌표 변환 계산을 캐싱하여 중복 계산 감소
   - 회전 중이 아닐 때는 변환 스킵

2. **코드 구조 개선**
   - 좌표 변환 로직을 별도 유틸리티 함수로 분리
   - `CoordinateTransform` 클래스 생성 고려

3. **추가 테스트**
   - 다양한 회전 각도에서의 엣지 케이스 테스트
   - 연속 회전 시 정확도 검증
